# -*- coding: utf-8 -*-
# Author: Mehmet Kurtipek

from audioop import add
# from tkinter.font import ROMAN
from scrapy.loader.processors import MapCompose
from scrapy import Spider
from scrapy import Request,FormRequest
from scrapy.selector import Selector
from w3lib.html import remove_tags
from python_spiders.loaders import ListingLoader
import json
import dateparser
import re
 
class MySpider(Spider):
    name = 'sothebysrealty_com'
    execution_type='testing'
    country='belgium'
    locale='nl'
    external_source='Sothebysrealty_PySpider_belgium'
    custom_settings = {
    "HTTPCACHE_ENABLED": False
    }

    def start_requests(self):

        headers = {
            "accept": "*/*", 
            "accept-encoding": "gzip, deflate, br",
            "accept-language": "tr-TR,tr;q=0.9,en-US;q=0.8,en;q=0.7",
            "content-type": "application/json",
            "origin": "https://www.sothebysrealty.com",
            "referer": "https://www.sothebysrealty.com/eng/rentals/int/",
            "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36" 
        }
        payload ={"operationName":"getSearchListingsPage","variables":{"language":"eng","channel":"rentals","locationSeo":"int","currency":"USD","refinemetsSeo":[],"unitSystem":"Imperial","cookies":["null","v3fvblebnczjejx0qzn5oxvr"],"rebranding":"","isMp":""},"query":"query getSearchListingsPage($affiliate: String, $language: String!, $channel: String!, $locationSeo: String!, $currency: String, $refinemetsSeo: [String], $sortSeo: String, $unitSystem: String, $cookies: [String], $rebranding: String, $isMp: String) {\n  getSearchListingsPage(\n    affiliate: $affiliate\n    language: $language\n    channel: $channel\n    locationSeo: $locationSeo\n    currency: $currency\n    refinemetsSeo: $refinemetsSeo\n    sortSeo: $sortSeo\n    unitSystem: $unitSystem\n    cookies: $cookies\n    rebranding: $rebranding\n    isMp: $isMp\n  ) {\n    listingtotal\n    listingtotalall\n    perpage\n    page\n    pagetotal\n    sortOptions {\n      title\n      value\n      selected\n      __typename\n    }\n    Guid\n    sortParameters {\n      CurrentPageSEOUrl\n      sort\n      __typename\n    }\n    keyword\n    listing {\n      id\n      IdWeb\n      BathsFull\n      BathsPartial\n      Bedroom\n      LotSizeDisplay\n      LotAcreage\n      LotSqMeters\n      SqFeetInteriorDisplay\n      SqMetersInterior\n      AdvertiserName\n      ListingAttribution\n      CanonicalUrl\n      HeaderImage\n      DecodePropertyType\n      DecodeLifeStyle\n      address {\n        addrcity\n        addrcountry\n        addrcounty\n        addrdisplay\n        addrstate\n        addrstateabbr\n        addrzip\n        countryiso3\n        address\n        addrneighborhoodprimary\n        addrstategroupprimary\n        addrcountrygroup\n        addrneighborhood\n        template\n        __typename\n      }\n      nophotourl\n      photos {\n        photo {\n          url\n          __typename\n        }\n        __typename\n      }\n      statusflags {\n        firstlook\n        contractpending\n        openhouse\n        new\n        video\n        vrtour\n        offerpending\n        __typename\n      }\n      VirtualTour3D\n      mainprice {\n        display\n        current {\n          value\n          formatted\n          iso\n          symbol\n          __typename\n        }\n        local {\n          value\n          formatted\n          iso\n          symbol\n          __typename\n        }\n        __typename\n      }\n      Latitude\n      Longitude\n      videoclip {\n        url\n        __typename\n      }\n      isSavedListing\n      availability {\n        period {\n          title\n          intervalseo\n          rate {\n            formatted\n            __typename\n          }\n          __typename\n        }\n        __typename\n      }\n      DecodeRentalFrequency\n      DataSourceType\n      openhouse {\n        startdate\n        enddate\n        duration\n        date\n        datelong\n        timevalue\n        year\n        month\n        day\n        isvirtual\n        url\n        __typename\n      }\n      location\n      RelatedRegions {\n        RelatedRegion {\n          name\n          __typename\n        }\n        __typename\n      }\n      BrokerName\n      BrokerIdUrl\n      Guid\n      __typename\n    }\n    recordMarkers {\n      id\n      size\n      fullresultindex\n      latlng {\n        lat\n        lng\n        __typename\n      }\n      tooltip\n      address\n      name\n      text\n      status\n      __typename\n    }\n    kml {\n      id\n      shape\n      __typename\n    }\n    siteMapFooter {\n      citiesbycountry {\n        index\n        title\n        total\n        seourl\n        __typename\n      }\n      citiesbystate {\n        index\n        title\n        total\n        seourl\n        __typename\n      }\n      nearbycities {\n        index\n        title\n        total\n        seourl\n        __typename\n      }\n      neighborhoods {\n        index\n        title\n        total\n        seourl\n        __typename\n      }\n      propertytypes {\n        index\n        title\n        total\n        seourl\n        __typename\n      }\n      lifestyles {\n        index\n        title\n        total\n        seourl\n        __typename\n      }\n      location {\n        searchlevel\n        statename\n        cityname\n        countryname\n        __typename\n      }\n      channel\n      LocationSeo\n      ParentLocationSeo\n      newlistingsresultspagelink {\n        url\n        text\n        __typename\n      }\n      __typename\n    }\n    breadcrumbs {\n      name\n      idregion\n      seo\n      level\n      countryiso3\n      stateiso2\n      lng\n      lat\n      __typename\n    }\n    location {\n      name\n      idregion\n      seo\n      level\n      countryiso3\n      stateiso2\n      lng\n      lat\n      selected\n      location {\n        name\n        idregion\n        seo\n        level\n        countryiso3\n        stateiso2\n        lng\n        lat\n        selected\n        location {\n          name\n          idregion\n          seo\n          level\n          countryiso3\n          stateiso2\n          lng\n          lat\n          selected\n          location {\n            name\n            idregion\n            seo\n            level\n            countryiso3\n            stateiso2\n            lng\n            lat\n            selected\n            location {\n              name\n              idregion\n              seo\n              level\n              countryiso3\n              stateiso2\n              lng\n              lat\n              selected\n              __typename\n            }\n            __typename\n          }\n          __typename\n        }\n        __typename\n      }\n      __typename\n    }\n    refinementsOptions {\n      Channel {\n        title\n        value\n        selected\n        __typename\n      }\n      PriceRange {\n        title\n        value\n        selected\n        __typename\n      }\n      Bedrooms {\n        title\n        value\n        selected\n        __typename\n      }\n      Bathrooms {\n        title\n        value\n        selected\n        __typename\n      }\n      AcresRange {\n        title\n        value\n        selected\n        __typename\n      }\n      SqFtRange {\n        title\n        value\n        selected\n        __typename\n      }\n      OpenHouses {\n        title\n        value\n        selected\n        __typename\n      }\n      DataSourceType {\n        title\n        value\n        selected\n        __typename\n      }\n      PropertyType {\n        title\n        value\n        selected\n        __typename\n      }\n      Amenities {\n        title\n        value\n        selected\n        __typename\n      }\n      LifeStyle {\n        title\n        value\n        selected\n        __typename\n      }\n      ShowOnly {\n        title\n        value\n        selected\n        __typename\n      }\n      DatePosted {\n        title\n        value\n        selected\n        __typename\n      }\n      ArchitecturalStyle {\n        title\n        value\n        selected\n        __typename\n      }\n      BodiesOfWater {\n        title\n        value\n        selected\n        __typename\n      }\n      Keyword {\n        title\n        value\n        selected\n        __typename\n      }\n      Filters {\n        title\n        value\n        selected\n        __typename\n      }\n      Currencies {\n        title\n        value\n        selected\n        __typename\n      }\n      SearchBy {\n        title\n        value\n        selected\n        __typename\n      }\n      RadiusOptions {\n        title\n        value\n        selected\n        __typename\n      }\n      __typename\n    }\n    customHtmlContainers {\n      containertype\n      text\n      __typename\n    }\n    salesmeta {\n      phrase\n      __typename\n    }\n    privateExclusives {\n      bannerImage\n      totalPrivateListings\n      seoQuery\n      __typename\n    }\n    parameters {\n      RadiusSearch\n      __typename\n    }\n    DefaultMapBounds\n    MyPortfolio {\n      member {\n        username\n        email\n        phone\n        country\n        state\n        city\n        enableemailalert\n        htmlalertformat\n        provider\n        agentassociationid\n        brokerassociationid\n        __typename\n      }\n      singlesignonproviders {\n        name\n        enabled\n        setting {\n          name\n          value\n          __typename\n        }\n        __typename\n      }\n      parameters {\n        IsSavedSearch\n        IsSignedIn\n        __typename\n      }\n      __typename\n    }\n    Branding {\n      textmode\n      imageortext\n      text\n      image {\n        imageurl\n        url\n        width\n        height\n        alt\n        __typename\n      }\n      AgentLicense\n      AgentTitle\n      phones {\n        name\n        decrypted\n        encrypted\n        __typename\n      }\n      BrandedBrokerName\n      BrandedBrokerDetailPageUrl\n      BrokerAddress\n      BrandedLogoUrl\n      BrandedDetailPageUrl\n      BrandedName\n      RequestSource\n      __typename\n    }\n    metaInfo {\n      title\n      keywords\n      description\n      __typename\n    }\n    preferences {\n      currencyselectormodule {\n        currencyresult {\n          currency {\n            rate\n            currencyname\n            culturecode\n            symbol\n            id\n            isocurrencysymbol\n            __typename\n          }\n          __typename\n        }\n        __typename\n      }\n      translationmodule {\n        pageseourl\n        currentlanguage\n        languages {\n          name\n          id\n          iso\n          url\n          __typename\n        }\n        __typename\n      }\n      __typename\n    }\n    headers {\n      title\n      value\n      __typename\n    }\n    redirect {\n      status\n      url\n      __typename\n    }\n    LandingPageSearch {\n      id\n      landing_page_search_data {\n        landing_page_search_config {\n          configurationkey\n          layout {\n            row {\n              column {\n                lps_control {\n                  module\n                  customAttributes\n                  text\n                  value\n                  __typename\n                }\n                __typename\n              }\n              __typename\n            }\n            __typename\n          }\n          settings\n          __typename\n        }\n        __typename\n      }\n      __typename\n    }\n    navigation {\n      links {\n        link {\n          UseNoFollowRel\n          text\n          title\n          originalurl\n          url\n          cssclass\n          target\n          links {\n            link {\n              UseNoFollowRel\n              text\n              title\n              originalurl\n              url\n              cssclass\n              target\n              links {\n                link {\n                  UseNoFollowRel\n                  text\n                  title\n                  originalurl\n                  url\n                  cssclass\n                  target\n                  __typename\n                }\n                __typename\n              }\n              __typename\n            }\n            __typename\n          }\n          __typename\n        }\n        __typename\n      }\n      __typename\n    }\n    footer {\n      additionalCopy\n      affiliateInfo {\n        text1\n        link {\n          url\n          label\n          __typename\n        }\n        __typename\n      }\n      links {\n        link {\n          UseNoFollowRel\n          text\n          title\n          originalurl\n          url\n          cssclass\n          target\n          links {\n            link {\n              UseNoFollowRel\n              text\n              title\n              originalurl\n              url\n              cssclass\n              target\n              __typename\n            }\n            __typename\n          }\n          __typename\n        }\n        __typename\n      }\n      __typename\n    }\n    ArticleData {\n      category\n      fullseourl\n      seopath\n      seourl\n      title\n      __typename\n    }\n    GeneralContentList {\n      id\n      componentName\n      title1\n      title2\n      text1\n      text2\n      image {\n        src\n        alt\n        text\n        link\n        __typename\n      }\n      link {\n        url\n        label\n        __typename\n      }\n      linksList {\n        label\n        url\n        __typename\n      }\n      __typename\n    }\n    __typename\n  }\n}\n"}
        
        yield Request(
            "https://middleware.sothebysrealty.com/graphql",
            callback=self.parse,
            body=json.dumps(payload), 
            method="POST",
            headers=headers,
            dont_filter=True
        )
    # 1. FOLLOWING
    def parse(self, response):
        page = response.meta.get("page", 2)
        seen=False
        data=json.loads(response.body)['data']['getSearchListingsPage']['listing']
        for item in data:
            itemurl="https://www.sothebysrealty.com"+item['CanonicalUrl']
            yield Request(itemurl, callback=self.populate_item,meta={'item':item})
            seen=True
        if page==2 or seen:
      
            headers = {
            "accept": "*/*", 
            "accept-encoding": "gzip, deflate, br",
            "accept-language": "tr-TR,tr;q=0.9,en-US;q=0.8,en;q=0.7",
            "content-type": "application/json",
            "origin": "https://www.sothebysrealty.com",
            "referer": "https://www.sothebysrealty.com/eng/rentals/int/",
            "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36" 
            }
            payload ={"operationName":"getSearchListingsPage","variables":{"language":"eng","channel":"rentals","locationSeo":"int","currency":"USD","refinemetsSeo":[str(page)+"-pg"],"unitSystem":"Imperial","cookies":["null","v3fvblebnczjejx0qzn5oxvr"],"rebranding":"","isMp":""},"query":"query getSearchListingsPage($affiliate: String, $language: String!, $channel: String!, $locationSeo: String!, $currency: String, $refinemetsSeo: [String], $sortSeo: String, $unitSystem: String, $cookies: [String], $rebranding: String, $isMp: String) {\n  getSearchListingsPage(\n    affiliate: $affiliate\n    language: $language\n    channel: $channel\n    locationSeo: $locationSeo\n    currency: $currency\n    refinemetsSeo: $refinemetsSeo\n    sortSeo: $sortSeo\n    unitSystem: $unitSystem\n    cookies: $cookies\n    rebranding: $rebranding\n    isMp: $isMp\n  ) {\n    listingtotal\n    listingtotalall\n    perpage\n    page\n    pagetotal\n    sortOptions {\n      title\n      value\n      selected\n      __typename\n    }\n    Guid\n    sortParameters {\n      CurrentPageSEOUrl\n      sort\n      __typename\n    }\n    keyword\n    listing {\n      id\n      IdWeb\n      BathsFull\n      BathsPartial\n      Bedroom\n      LotSizeDisplay\n      LotAcreage\n      LotSqMeters\n      SqFeetInteriorDisplay\n      SqMetersInterior\n      AdvertiserName\n      ListingAttribution\n      CanonicalUrl\n      HeaderImage\n      DecodePropertyType\n      DecodeLifeStyle\n      address {\n        addrcity\n        addrcountry\n        addrcounty\n        addrdisplay\n        addrstate\n        addrstateabbr\n        addrzip\n        countryiso3\n        address\n        addrneighborhoodprimary\n        addrstategroupprimary\n        addrcountrygroup\n        addrneighborhood\n        template\n        __typename\n      }\n      nophotourl\n      photos {\n        photo {\n          url\n          __typename\n        }\n        __typename\n      }\n      statusflags {\n        firstlook\n        contractpending\n        openhouse\n        new\n        video\n        vrtour\n        offerpending\n        __typename\n      }\n      VirtualTour3D\n      mainprice {\n        display\n        current {\n          value\n          formatted\n          iso\n          symbol\n          __typename\n        }\n        local {\n          value\n          formatted\n          iso\n          symbol\n          __typename\n        }\n        __typename\n      }\n      Latitude\n      Longitude\n      videoclip {\n        url\n        __typename\n      }\n      isSavedListing\n      availability {\n        period {\n          title\n          intervalseo\n          rate {\n            formatted\n            __typename\n          }\n          __typename\n        }\n        __typename\n      }\n      DecodeRentalFrequency\n      DataSourceType\n      openhouse {\n        startdate\n        enddate\n        duration\n        date\n        datelong\n        timevalue\n        year\n        month\n        day\n        isvirtual\n        url\n        __typename\n      }\n      location\n      RelatedRegions {\n        RelatedRegion {\n          name\n          __typename\n        }\n        __typename\n      }\n      BrokerName\n      BrokerIdUrl\n      Guid\n      __typename\n    }\n    recordMarkers {\n      id\n      size\n      fullresultindex\n      latlng {\n        lat\n        lng\n        __typename\n      }\n      tooltip\n      address\n      name\n      text\n      status\n      __typename\n    }\n    kml {\n      id\n      shape\n      __typename\n    }\n    siteMapFooter {\n      citiesbycountry {\n        index\n        title\n        total\n        seourl\n        __typename\n      }\n      citiesbystate {\n        index\n        title\n        total\n        seourl\n        __typename\n      }\n      nearbycities {\n        index\n        title\n        total\n        seourl\n        __typename\n      }\n      neighborhoods {\n        index\n        title\n        total\n        seourl\n        __typename\n      }\n      propertytypes {\n        index\n        title\n        total\n        seourl\n        __typename\n      }\n      lifestyles {\n        index\n        title\n        total\n        seourl\n        __typename\n      }\n      location {\n        searchlevel\n        statename\n        cityname\n        countryname\n        __typename\n      }\n      channel\n      LocationSeo\n      ParentLocationSeo\n      newlistingsresultspagelink {\n        url\n        text\n        __typename\n      }\n      __typename\n    }\n    breadcrumbs {\n      name\n      idregion\n      seo\n      level\n      countryiso3\n      stateiso2\n      lng\n      lat\n      __typename\n    }\n    location {\n      name\n      idregion\n      seo\n      level\n      countryiso3\n      stateiso2\n      lng\n      lat\n      selected\n      location {\n        name\n        idregion\n        seo\n        level\n        countryiso3\n        stateiso2\n        lng\n        lat\n        selected\n        location {\n          name\n          idregion\n          seo\n          level\n          countryiso3\n          stateiso2\n          lng\n          lat\n          selected\n          location {\n            name\n            idregion\n            seo\n            level\n            countryiso3\n            stateiso2\n            lng\n            lat\n            selected\n            location {\n              name\n              idregion\n              seo\n              level\n              countryiso3\n              stateiso2\n              lng\n              lat\n              selected\n              __typename\n            }\n            __typename\n          }\n          __typename\n        }\n        __typename\n      }\n      __typename\n    }\n    refinementsOptions {\n      Channel {\n        title\n        value\n        selected\n        __typename\n      }\n      PriceRange {\n        title\n        value\n        selected\n        __typename\n      }\n      Bedrooms {\n        title\n        value\n        selected\n        __typename\n      }\n      Bathrooms {\n        title\n        value\n        selected\n        __typename\n      }\n      AcresRange {\n        title\n        value\n        selected\n        __typename\n      }\n      SqFtRange {\n        title\n        value\n        selected\n        __typename\n      }\n      OpenHouses {\n        title\n        value\n        selected\n        __typename\n      }\n      DataSourceType {\n        title\n        value\n        selected\n        __typename\n      }\n      PropertyType {\n        title\n        value\n        selected\n        __typename\n      }\n      Amenities {\n        title\n        value\n        selected\n        __typename\n      }\n      LifeStyle {\n        title\n        value\n        selected\n        __typename\n      }\n      ShowOnly {\n        title\n        value\n        selected\n        __typename\n      }\n      DatePosted {\n        title\n        value\n        selected\n        __typename\n      }\n      ArchitecturalStyle {\n        title\n        value\n        selected\n        __typename\n      }\n      BodiesOfWater {\n        title\n        value\n        selected\n        __typename\n      }\n      Keyword {\n        title\n        value\n        selected\n        __typename\n      }\n      Filters {\n        title\n        value\n        selected\n        __typename\n      }\n      Currencies {\n        title\n        value\n        selected\n        __typename\n      }\n      SearchBy {\n        title\n        value\n        selected\n        __typename\n      }\n      RadiusOptions {\n        title\n        value\n        selected\n        __typename\n      }\n      __typename\n    }\n    customHtmlContainers {\n      containertype\n      text\n      __typename\n    }\n    salesmeta {\n      phrase\n      __typename\n    }\n    privateExclusives {\n      bannerImage\n      totalPrivateListings\n      seoQuery\n      __typename\n    }\n    parameters {\n      RadiusSearch\n      __typename\n    }\n    DefaultMapBounds\n    MyPortfolio {\n      member {\n        username\n        email\n        phone\n        country\n        state\n        city\n        enableemailalert\n        htmlalertformat\n        provider\n        agentassociationid\n        brokerassociationid\n        __typename\n      }\n      singlesignonproviders {\n        name\n        enabled\n        setting {\n          name\n          value\n          __typename\n        }\n        __typename\n      }\n      parameters {\n        IsSavedSearch\n        IsSignedIn\n        __typename\n      }\n      __typename\n    }\n    Branding {\n      textmode\n      imageortext\n      text\n      image {\n        imageurl\n        url\n        width\n        height\n        alt\n        __typename\n      }\n      AgentLicense\n      AgentTitle\n      phones {\n        name\n        decrypted\n        encrypted\n        __typename\n      }\n      BrandedBrokerName\n      BrandedBrokerDetailPageUrl\n      BrokerAddress\n      BrandedLogoUrl\n      BrandedDetailPageUrl\n      BrandedName\n      RequestSource\n      __typename\n    }\n    metaInfo {\n      title\n      keywords\n      description\n      __typename\n    }\n    preferences {\n      currencyselectormodule {\n        currencyresult {\n          currency {\n            rate\n            currencyname\n            culturecode\n            symbol\n            id\n            isocurrencysymbol\n            __typename\n          }\n          __typename\n        }\n        __typename\n      }\n      translationmodule {\n        pageseourl\n        currentlanguage\n        languages {\n          name\n          id\n          iso\n          url\n          __typename\n        }\n        __typename\n      }\n      __typename\n    }\n    headers {\n      title\n      value\n      __typename\n    }\n    redirect {\n      status\n      url\n      __typename\n    }\n    LandingPageSearch {\n      id\n      landing_page_search_data {\n        landing_page_search_config {\n          configurationkey\n          layout {\n            row {\n              column {\n                lps_control {\n                  module\n                  customAttributes\n                  text\n                  value\n                  __typename\n                }\n                __typename\n              }\n              __typename\n            }\n            __typename\n          }\n          settings\n          __typename\n        }\n        __typename\n      }\n      __typename\n    }\n    navigation {\n      links {\n        link {\n          UseNoFollowRel\n          text\n          title\n          originalurl\n          url\n          cssclass\n          target\n          links {\n            link {\n              UseNoFollowRel\n              text\n              title\n              originalurl\n              url\n              cssclass\n              target\n              links {\n                link {\n                  UseNoFollowRel\n                  text\n                  title\n                  originalurl\n                  url\n                  cssclass\n                  target\n                  __typename\n                }\n                __typename\n              }\n              __typename\n            }\n            __typename\n          }\n          __typename\n        }\n        __typename\n      }\n      __typename\n    }\n    footer {\n      additionalCopy\n      affiliateInfo {\n        text1\n        link {\n          url\n          label\n          __typename\n        }\n        __typename\n      }\n      links {\n        link {\n          UseNoFollowRel\n          text\n          title\n          originalurl\n          url\n          cssclass\n          target\n          links {\n            link {\n              UseNoFollowRel\n              text\n              title\n              originalurl\n              url\n              cssclass\n              target\n              __typename\n            }\n            __typename\n          }\n          __typename\n        }\n        __typename\n      }\n      __typename\n    }\n    ArticleData {\n      category\n      fullseourl\n      seopath\n      seourl\n      title\n      __typename\n    }\n    GeneralContentList {\n      id\n      componentName\n      title1\n      title2\n      text1\n      text2\n      image {\n        src\n        alt\n        text\n        link\n        __typename\n      }\n      link {\n        url\n        label\n        __typename\n      }\n      linksList {\n        label\n        url\n        __typename\n      }\n      __typename\n    }\n    __typename\n  }\n}\n"}
            yield Request(
                "https://middleware.sothebysrealty.com/graphql",
                callback=self.parse,
                body=json.dumps(payload), 
                method="POST",
                headers=headers,
                dont_filter=True,
                meta={'page':page+1}
                
            )

    # 2. SCRAPING level 2
    def populate_item(self, response):
        item_loader = ListingLoader(response=response)
        item_loader.add_value("external_link", response.url)
        item_loader.add_value("external_source", self.external_source)

        item=response.meta.get('item')
 
       
        adres=str(item['address']['addrcity'])+" "+str(item['address']['addrcountry'])+" "+str(item['address']['addrzip'])
        if adres:
            item_loader.add_value("address",adres)
        external_id=item['id']
        if external_id:
            item_loader.add_value("external_id",external_id)
        bathroom_count=item['BathsFull']
        if bathroom_count:
            item_loader.add_value("bathroom_count",bathroom_count)
        room_count=item['Bedroom']
        if room_count:
            item_loader.add_value("room_count",room_count)
        title=response.xpath("//title//text()").get()
        if title:
            item_loader.add_value("title",title)
        rent=item['mainprice']['local']['value']
        if rent:
            item_loader.add_value("rent",rent)
        item_loader.add_value("currency","USD")
        square_meters=response.xpath("//span[.='Sq Ft.']/preceding-sibling::text()").get()
        if square_meters:
            square_meters=square_meters.replace(",","").strip()
            if square_meters:
                square_meters=str(int(float(square_meters) * 0.09290304))
                if square_meters:
                    item_loader.add_value("square_meters",square_meters)
                
        images=str(item['photos']['photo'])
        img=[]
        if images:
            for i in images.split("url"):
                if "sir" in i:
            
                    img.append(i.split("typename")[0].split(":")[-1].replace("__","").replace("'","").replace('"',""))
            item_loader.add_value("images",img)
        latitude=item['Latitude']
        if latitude:
            item_loader.add_value("latitude",latitude)
        longitude=item['Longitude']
        if longitude:
            item_loader.add_value("longitude",longitude)
        description="".join(response.xpath("//div[@class='ListingDescription__description--text p u-color-dark-grey']//p//text()").getall())
        if description:
            item_loader.add_value("description",description)
        item_loader.add_value("landlord_name","Sotheby's International")

        yield item_loader.load_item()